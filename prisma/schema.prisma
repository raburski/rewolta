// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

enum UserRole {
	USER
	MODERATOR
	ADMIN
}

enum UserStatus {
	ACTIVE
	BANNED
	DELETED
}

enum BuildingProductStatus {
	ACTIVE
	INACTIVE
}

enum SubmissionStatus {
	PENDING
	PUBLISHED
	WITHDRAWN
	FLAGGED
}

// NextAuth.js required models
model Account {
	id                String  @id @default(cuid())
	userId            String
	type              String
	provider          String
	providerAccountId String
	refresh_token     String? @db.Text
	access_token      String? @db.Text
	expires_at        Int?
	token_type        String?
	scope             String?
	id_token          String? @db.Text
	session_state     String?

	user User @relation(fields: [userId], references: [id], onDelete: Cascade)

	@@unique([provider, providerAccountId])
	@@index([userId])
}

model Session {
	id           String   @id @default(cuid())
	sessionToken String   @unique
	userId       String
	expires      DateTime
	user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

	@@index([userId])
}

model User {
	id            String      @id @default(cuid())
	name          String?
	email         String?     @unique
	emailVerified DateTime?
	image         String?
	role          UserRole    @default(USER)
	status        UserStatus  @default(ACTIVE)
	accounts      Account[]
	sessions      Session[]
	submissions   BuildingSubmission[]
	comparisons   Comparison[]
	createdAt     DateTime    @default(now())
	updatedAt     DateTime    @updatedAt
}

model VerificationToken {
	identifier String
	token      String   @unique
	expires    DateTime

	@@unique([identifier, token])
}

model BuildingProduct {
	id          String                @id
	name        String
	imageUrl    String                @db.Text
	description String                @db.Text
	cdnUrl      String                @db.Text
	status      BuildingProductStatus @default(INACTIVE)
	createdAt   DateTime              @default(now())
	updatedAt   DateTime              @updatedAt
	submissions BuildingSubmission[]

	@@index([id])
	@@index([status])
}

model BuildingSubmission {
	id               String           @id @default(cuid())
	imageId          String
	productId        String
	userId           String
	status           SubmissionStatus @default(PUBLISHED)
	submittedAt      DateTime         @default(now())
	publishedAt      DateTime?
	withdrawnAt      DateTime?
	
	// ELO rating
	eloRating        Int              @default(1500)
	totalComparisons Int              @default(0)
	wins             Int              @default(0)
	losses           Int              @default(0)
	
	// Relations
	comparisonsAsA   Comparison[]     @relation("ComparisonA")
	comparisonsAsB   Comparison[]     @relation("ComparisonB")
	comparisonsWon   Comparison[]     @relation("ComparisonWinner")
	tags             SubmissionTag[]
	user             User             @relation(fields: [userId], references: [id])
	product          BuildingProduct  @relation(fields: [productId], references: [id])
	
	@@index([productId])
	@@index([userId])
	@@index([status])
	@@index([publishedAt])
	@@index([eloRating])
}

model Comparison {
	id            String   @id @default(cuid())
	submissionAId String
	submissionBId String
	userId        String
	winnerId      String
	createdAt     DateTime @default(now())
	
	// Optional tags added during comparison
	tags          ComparisonTag[]
	
	submissionA   BuildingSubmission @relation("ComparisonA", fields: [submissionAId], references: [id])
	submissionB   BuildingSubmission @relation("ComparisonB", fields: [submissionBId], references: [id])
	winner        BuildingSubmission @relation("ComparisonWinner", fields: [winnerId], references: [id])
	user          User               @relation(fields: [userId], references: [id])
	
	@@index([submissionAId])
	@@index([submissionBId])
	@@index([userId])
	@@index([createdAt])
}

model ComparisonTag {
	id            String   @id @default(cuid())
	comparisonId  String
	submissionId  String
	tag           String
	side          String   // "A" or "B" to indicate which building the tag is for
	
	comparison    Comparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
	
	@@index([comparisonId])
	@@index([submissionId, tag])
}

model SubmissionTag {
	id            String   @id @default(cuid())
	submissionId  String
	tag           String
	count         Int      @default(1)
	
	submission    BuildingSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
	
	@@unique([submissionId, tag])
	@@index([tag])
	@@index([count])
}
